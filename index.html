<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Granja Pro üì∏</title>
    <style>
        /* ESTILOS GENERALES */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f0f2f5; 
            margin: 0; 
            padding-bottom: 90px; /* Espacio para el men√∫ inferior */
        }
        
        /* HEADER FIJO */
        header { 
            background-color: #2c3e50; 
            color: white; 
            padding: 15px; 
            text-align: center; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        h2 { margin: 0; font-size: 1.2rem; letter-spacing: 0.5px; }

        /* PESTA√ëAS */
        .tab-content { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        
        /* FORMULARIO */
        .card-form { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
        }
        label { 
            display: block; 
            font-weight: 600; 
            margin-top: 15px; 
            color: #34495e; 
            font-size: 0.95rem;
        }
        input, select { 
            width: 100%; 
            padding: 12px; 
            margin-top: 5px; 
            border: 1px solid #bdc3c7; 
            border-radius: 8px; 
            box-sizing: border-box; 
            background: #fff; 
            font-size: 16px; /* Evita zoom en iPhone */
        }
        
        /* BOT√ìN FOTO */
        .file-upload-wrapper { 
            margin-top: 15px; 
            border: 2px dashed #bdc3c7; 
            padding: 20px; 
            text-align: center; 
            border-radius: 8px; 
            cursor: pointer; 
            background: #f9f9f9; 
            transition: all 0.3s;
        }
        .file-upload-wrapper.has-file { 
            border-color: #27ae60; 
            background: #e9f7ef; 
        }
        input[type="file"] { display: none; }
        
        /* BOT√ìN PRINCIPAL */
        button.btn-primary { 
            width: 100%; 
            padding: 15px; 
            background-color: #2980b9; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 18px; 
            font-weight: bold; 
            margin-top: 25px; 
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(41, 128, 185, 0.3);
        }
        button:disabled { background-color: #95a5a6; box-shadow: none; }

        /* DASHBOARD */
        .grid-dashboard { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
        }
        .card-dash { 
            background: white; 
            padding: 15px; 
            border-radius: 12px; 
            text-align: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        .card-dash h3 { margin: 0; font-size: 0.8rem; color: #7f8c8d; text-transform: uppercase; }
        .card-dash h2 { margin: 10px 0 0 0; font-size: 2rem; color: #2c3e50; }

        /* MEN√ö INFERIOR */
        .nav-bar { 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            background: white; 
            display: flex; 
            justify-content: space-around; 
            padding: 12px 0; 
            border-top: 1px solid #eee; 
            z-index: 90; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-btn { 
            background: none; 
            border: none; 
            font-size: 1.5rem; 
            color: #bdc3c7;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .nav-btn span { font-size: 0.7rem; margin-top: 2px; font-weight: bold; }
        .nav-btn.active { color: #2980b9; }

        /* UTILIDADES */
        .loader { text-align: center; padding: 20px; display: none; color: #7f8c8d; }
        #preview-img { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; display: none; border: 1px solid #ddd; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Checkbox grande */
        .checkbox-row { display: flex; align-items: center; margin-top: 15px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #e0e0e0; }
        .checkbox-row input { width: 25px; height: 25px; margin: 0 10px 0 0; }
    </style>
</head>
<body>

<header>
    <h2>üê∑ Granja Manager</h2>
</header>

<div id="tab-dashboard" class="tab-content active">
    <div class="loader" id="loader-dash">‚è≥ Sincronizando datos...</div>
    
    <div id="dash-view" style="display:none;">
        <div class="grid-dashboard">
            <div class="card-dash" style="grid-column: span 2; background: linear-gradient(135deg, #2ecc71, #27ae60); color: white;">
                <h3 style="color: #e9f7ef;">Total Animales</h3>
                <h2 id="total" style="color: white; font-size: 3rem;">0</h2>
            </div>
            
            <div class="card-dash">
                <h3>Paridera</h3>
                <h2 id="c-paridera">0</h2>
            </div>
            <div class="card-dash">
                <h3>Precebo</h3>
                <h2 id="c-precebo">0</h2>
            </div>
            <div class="card-dash">
                <h3>Levante</h3>
                <h2 id="c-levante">0</h2>
            </div>
            <div class="card-dash">
                <h3>Engorde</h3>
                <h2 id="c-engorde">0</h2>
            </div>
        </div>
        
        <div style="text-align:center; margin-top: 30px;">
            <button onclick="location.reload()" style="background:none; border:none; color:#2980b9; font-weight:bold; cursor:pointer; padding:10px;">
                üîÑ Actualizar ahora
            </button>
        </div>
    </div>
</div>

<div id="tab-registro" class="tab-content">
    <div class="card-form">
        <h3 style="margin-top:0; color:#2c3e50;">Nuevo Movimiento</h3>

        <label>Chapeta (ID):</label>
        <input type="number" id="chapeta" placeholder="Ej. 504" inputmode="numeric">

        <label>Acci√≥n:</label>
        <select id="accion" onchange="verificarAccion()">
            <option value="INGRESO">üü¢ Nacimiento / Compra</option>
            <option value="TRASLADO">üîµ Cambio de Corral</option>
            <option value="VENTA">üí∞ Venta</option>
            <option value="MUERTE">üî¥ Muerte / Baja</option>
        </select>

        <label>Ubicaci√≥n / Fase Nueva:</label>
        <select id="fase">
            <option value="PARIDERA">Paridera</option>
            <option value="PRECEBO">Precebo</option>
            <option value="LEVANTE">Levante</option>
            <option value="ENGORDE">Engorde</option>
            <option value="FUERA">Fuera de Granja</option>
        </select>
        
        <label>Genealog√≠a (Opcional):</label>
        <div style="display:flex; gap:10px;">
             <div style="flex:1">
                 <select id="madre">
                     <option value="">Cargando...</option>
                 </select>
             </div>
             <div style="flex:1">
                 <input type="text" id="padre" placeholder="Padre (ID)">
             </div>
        </div>

        <div class="checkbox-row">
             <input type="checkbox" id="esReproductora">
             <label style="margin:0; width:auto; font-weight:normal;">Marcar como <strong>Futura Madre</strong></label>
        </div>

        <label>Evidencia / Foto (Opcional):</label>
        <div class="file-upload-wrapper" id="drop-zone" onclick="document.getElementById('fotoInput').click()">
            <div id="text-foto">
                <span style="font-size:2rem;">üì∏</span><br>
                Toca para tomar foto
            </div>
            <input type="file" id="fotoInput" accept="image/*" capture="environment" onchange="procesarFoto()">
            <img id="preview-img" src="">
        </div>

        <label>Notas:</label>
        <input type="text" id="notas" placeholder="Peso, observaciones...">

        <button id="btnEnviar" class="btn-primary" onclick="enviarDatos()">Guardar Registro üíæ</button>
    </div>
</div>

<div class="nav-bar">
    <button class="nav-btn active" onclick="verTab('dashboard', this)">
        <span>üìä</span>
        <span>Tablero</span>
    </button>
    <button class="nav-btn" onclick="verTab('registro', this)">
        <span>‚ûï</span>
        <span>Registrar</span>
    </button>
</div>

<script>
    // --- TU NUEVA URL ---
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbxeIx7qOJyFYEF1k2jggGll1ha-RC_HZVkB2BNW27w4cBe6Mg8LsEJJOWXaWueDpuD7qw/exec";

    let imagenBase64 = ""; 
    let inventario = {}; 

    // Iniciar app
    window.onload = cargarDatos;

    function verTab(tabId, btn) {
        // Cambiar contenido
        document.querySelectorAll('.tab-content').forEach(d => d.style.display='none');
        document.getElementById('tab-'+tabId).style.display='block';
        
        // Cambiar botones activos
        if(btn) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
    }

    // --- CARGAR DATOS DEL SCRIPT ---
    function cargarDatos() {
        document.getElementById('loader-dash').style.display='block';
        
        fetch(URL_SCRIPT)
            .then(r => r.json())
            .then(data => {
                procesarDashboard(data);
                llenarMadres(data);
                document.getElementById('loader-dash').style.display='none';
                document.getElementById('dash-view').style.display='block';
            })
            .catch(error => {
                console.error(error);
                document.getElementById('loader-dash').innerHTML = "‚ö†Ô∏è Error de conexi√≥n<br><small>Verifica tu internet</small>";
            });
    }

    // --- PROCESAR INVENTARIO ---
    function procesarDashboard(data) {
        let counts = {PARIDERA:0, PRECEBO:0, LEVANTE:0, ENGORDE:0, TOTAL:0};
        let estados = {};
        
        // Recorremos historial
        data.forEach(fila => {
            // fila = [Fecha, Chapeta, Accion, Fase, Ubicacion, Notas, Padre, Madre, EsRepro, Foto]
            let id = fila[1], acc = fila[2], fase = fila[3];
            
            if(!estados[id]) estados[id] = {st:'?', fs:''};
            
            if(acc === 'VENTA' || acc === 'MUERTE') {
                estados[id].st = 'OFF';
                estados[id].fs = 'FUERA';
            } else {
                estados[id].st = 'ON';
                estados[id].fs = fase;
            }
        });

        // Contar activos
        for(let id in estados) {
            if(estados[id].st === 'ON') {
                counts.TOTAL++;
                // Normalizar texto por si viene en min√∫sculas
                let faseKey = estados[id].fs ? estados[id].fs.toUpperCase() : "DESCONOCIDO";
                if(counts[faseKey] !== undefined) counts[faseKey]++;
            }
        }

        // Pintar n√∫meros
        document.getElementById('total').innerText = counts.TOTAL;
        document.getElementById('c-paridera').innerText = counts.PARIDERA;
        document.getElementById('c-precebo').innerText = counts.PRECEBO;
        document.getElementById('c-levante').innerText = counts.LEVANTE;
        document.getElementById('c-engorde').innerText = counts.ENGORDE;
    }

    // --- LLENAR SELECT DE MADRES ---
    function llenarMadres(data) {
        let sel = document.getElementById('madre');
        sel.innerHTML = '<option value="">-- Sel --</option><option value="NA">N/A</option><option value="COMPRA">Externa</option>';
        
        let madres = new Set();
        data.forEach(r => { 
            // Si columna EsReproductora (index 8) es SI
            if(r[8] === 'SI') madres.add(r[1]); 
        });
        
        madres.forEach(m => {
            let o = document.createElement('option'); 
            o.value=m; 
            o.text="Madre " + m; 
            sel.add(o);
        });
    }

    // --- COMPRESI√ìN DE FOTO ---
    function procesarFoto() {
        const file = document.getElementById('fotoInput').files[0];
        if (!file) return;

        document.getElementById('text-foto').innerHTML = "‚è≥ Procesando...";

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(event) {
            const imgElement = document.createElement("img");
            imgElement.src = event.target.result;
            
            imgElement.onload = function() {
                // Redimensionar a max 800px para que suba r√°pido
                const canvas = document.createElement("canvas");
                const MAX_WIDTH = 800;
                const scaleSize = MAX_WIDTH / imgElement.width;
                canvas.width = MAX_WIDTH;
                canvas.height = imgElement.height * scaleSize;

                const ctx = canvas.getContext("2d");
                ctx.drawImage(imgElement, 0, 0, canvas.width, canvas.height);

                // Comprimir a JPG calidad 60%
                imagenBase64 = canvas.toDataURL("image/jpeg", 0.6).split(",")[1]; 

                // Mostrar preview
                const preview = document.getElementById('preview-img');
                preview.src = canvas.toDataURL("image/jpeg", 0.6);
                preview.style.display = 'block';
                
                document.getElementById('text-foto').innerHTML = "‚úÖ Foto Lista";
                document.getElementById('drop-zone').classList.add('has-file');
            }
        }
    }

    // --- ENV√çO DE DATOS ---
    function verificarAccion() {
        const accion = document.getElementById('accion').value;
        if(accion === 'MUERTE' || accion === 'VENTA') {
            document.getElementById('fase').value = 'FUERA';
        }
    }

    function enviarDatos() {
        const btn = document.getElementById('btnEnviar');
        
        const datos = {
            chapeta: document.getElementById('chapeta').value,
            accion: document.getElementById('accion').value,
            fase: document.getElementById('fase').value,
            ubicacion: document.getElementById('fase').value,
            notas: document.getElementById('notas').value,
            madre: document.getElementById('madre').value,
            padre: document.getElementById('padre').value,
            esReproductora: document.getElementById('esReproductora').checked ? "SI" : "NO",
            imagenBase64: imagenBase64,
            mimeType: "image/jpeg"
        };

        if(!datos.chapeta) { alert("‚ö†Ô∏è Falta el n√∫mero de Chapeta"); return; }
        
        btn.disabled = true;
        btn.innerText = "Subiendo a la nube... ‚òÅÔ∏è";

        fetch(URL_SCRIPT, {
            method: 'POST', 
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(datos)
        }).then(() => {
            alert("‚úÖ ¬°Guardado Exitosamente!");
            location.reload(); // Recargar para actualizar dashboard
        }).catch(e => {
            alert("‚ùå Error al subir. Intenta de nuevo.");
            btn.disabled = false;
            btn.innerText = "Reintentar";
        });
    }
</script>

</body>
</html>
