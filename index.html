<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Granja Pro v4.22 üê∑</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; margin: 0; padding-bottom: 90px; }
        header { background-color: #2c3e50; color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .search-container { padding: 10px 15px; background: #2c3e50; margin-bottom: 10px; }
        .search-box { width: 100%; padding: 12px; border-radius: 20px; border: none; font-size: 1rem; text-align: center; outline: none; }
        .tab-content { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        
        .grid-dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        /* TARJETAS DASHBOARD */
        .card-dash { background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; border-left: 5px solid transparent; position: relative; }
        .alert-badge { position: absolute; top: 10px; right: 10px; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .pulse-red { background-color: #e74c3c; animation: pulse 2s infinite; }
        .badge-yellow { background-color: #f1c40f; }

        .card-maestra { grid-column: span 2; background: linear-gradient(135deg, #2c3e50, #34495e); color: white; }
        .card-lechones { background: linear-gradient(135deg, #f39c12, #d35400); color: white; }
        .card-servicio { background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white; }
        
        .card-dash h3 { margin: 0; font-size: 0.75rem; text-transform: uppercase; opacity: 0.8; }
        .card-dash h2 { margin: 10px 0 0 0; font-size: 2rem; }

        .card-form { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        label { display: block; font-weight: 600; margin-top: 15px; color: #34495e; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #bdc3c7; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn-primary { width: 100%; padding: 15px; background-color: #2980b9; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; margin-top: 25px; cursor: pointer; }
        
        /* ESTILO LISTA */
        .item-lista { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #bdc3c7; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; position: relative; }
        .dot-status { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-left: 5px; }
        
        /* TIMELINE */
        .timeline-item { display: flex; gap: 15px; margin-bottom: 20px; position: relative; }
        .timeline-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 2; }
        .timeline-content { background: white; padding: 15px; border-radius: 12px; flex: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .timeline-line { position: absolute; left: 20px; top: 40px; bottom: -30px; width: 2px; background: #ddd; z-index: 1; }
        .timeline-item:last-child .timeline-line { display: none; }

        /* BOTONES DE ACCI√ìN */
        .btn-action-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn-action { padding: 12px; border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-orange { background-color: #e67e22; }
        .btn-blue { background-color: #2980b9; }
        .btn-purple { background-color: #8e44ad; grid-column: span 2; }
        .btn-parto { background-color: #d35400; grid-column: span 2; margin-top: 5px; }
        .btn-destete { background-color: #16a085; grid-column: span 2; margin-top: 5px; } 
        .btn-baja-lechon { background-color: #c0392b; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; cursor: pointer; margin-left: 10px; }

        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #eee; z-index: 100; }
        .nav-btn { background: none; border: none; font-size: 1.5rem; color: #bdc3c7; cursor: pointer; }
        .nav-btn.active { color: #2980b9; }

        .special-section { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #eee; }
        .preview-img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px; margin-top: 10px; display: none; }
        
        .lechon-item { display: grid; grid-template-columns: 40px 1fr 1fr 40px; gap: 5px; align-items: center; margin-top: 8px; background: white; padding: 5px; border-radius: 5px; border: 1px solid #eee; }
        .lechon-item input[type="checkbox"] { width: 20px; height: 20px; margin: 0 auto; cursor: pointer; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 6px rgba(231, 76, 60, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
    </style>
</head>
<body>

<header>
    <h2>üê∑ Granja Manager Pro</h2>
    <div class="search-container">
        <input type="text" id="inputBusqueda" class="search-box" list="lista-busqueda" placeholder="üîç Tatuaje o Chapeta..." oninput="buscarCerdo()">
        <datalist id="lista-busqueda"></datalist>
    </div>
</header>

<div id="tab-dashboard" class="tab-content active">
    <div id="loader-dash" style="text-align:center; padding:40px;">‚è≥ Sincronizando datos...</div>
    <div id="view-dashboard-summary" style="display:none;">
        <div class="grid-dashboard" id="dashboard-container"></div>
    </div>

    <div id="view-list" style="display:none;">
        <button onclick="volverAlTablero()" style="border:none; background:none; color:#2980b9; font-weight:bold; margin-bottom:15px;"><i class="fas fa-arrow-left"></i> Volver</button>
        <h3 id="titulo-lista">Listado</h3>
        <div id="contenedor-lista"></div>
    </div>

    <div id="view-detail" style="display:none;">
        <button onclick="volverALista()" style="border:none; background:none; color:#2980b9; font-weight:bold; margin-bottom:15px;"><i class="fas fa-arrow-left"></i> Volver</button>
        <div id="contenedor-detalle"></div>
    </div>
</div>

<div id="tab-registro" class="tab-content">
    <div class="card-form">
        <h3>Nuevo Registro</h3>
        <label>Acci√≥n:</label>
        <select id="accion" onchange="verificarAccion()">
            <option value="INGRESO">üü¢ Ingreso</option>
            <option value="SERVICIO">üíâ SERVICIO</option>
            <option value="PARTO">üê∑ PARTO</option>
            <option value="DESTETE">ü•£ DESTETE</option>
            <option value="BAJA_LACTANCIA">üíÄ Baja Lech√≥n (Lactancia)</option>
            <option value="TRASLADO">üîµ Traslado</option>
            <option value="VENTA">üí∞ Venta</option>
            <option value="MUERTE">üî¥ Muerte (Madre/Cerdo)</option>
            <option value="OBSERVACION">üìù Observaci√≥n / Peso</option>
        </select>

        <label>Tatuaje (ID):</label>
        <input type="text" id="tatuaje" list="lista-busqueda" placeholder="ID del animal">

        <div style="display:flex; gap:10px;">
            <div style="flex:1;"><label>Chapeta:</label><input type="text" id="chapeta" placeholder="N¬∞"></div>
            <div style="flex:1;"><label>Peso (kg):</label><input type="number" id="peso" placeholder="0.0"></div>
        </div>

        <div id="section-fase">
            <label>Ubicaci√≥n / Fase:</label>
            <div style="display:flex; gap:5px;">
                <select id="fase" style="flex:1"></select>
                <button class="btn-blue" onclick="agregarFase()" style="width:50px; margin-top:5px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:1.2rem;">+</button>
            </div>
            
            <label>Sub-Puesto (Jaula/Corral):</label>
            <input type="text" id="subpuesto" list="lista-subpuestos" placeholder="Escribe o selecciona...">
            <datalist id="lista-subpuestos"></datalist>
        </div>

        <div id="section-servicio" style="display:none;" class="special-section">
            <h4 style="margin:0 0 10px 0; color:#8e44ad;">Datos de Inseminaci√≥n</h4>
            <label>Inseminador:</label>
            <input type="text" id="inseminador" placeholder="Nombre del operario">
        </div>

        <div id="section-parto" style="display:none;" class="special-section">
            <h4 style="margin:0 0 10px 0; color:#d35400;">Registro de Camada</h4>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Vivos:</label><input type="number" id="vivos" placeholder="0"></div>
                <div style="flex:1;"><label>Muertos:</label><input type="number" id="muertos" placeholder="0"></div>
            </div>
            <label>Peso Total Nacimiento:</label><input type="number" id="peso_nacimiento" placeholder="0.0">
        </div>
        
        <div id="section-baja-lechon" style="display:none;" class="special-section">
            <h4 style="margin:0 0 10px 0; color:#c0392b;">Baja de Lech√≥n Lactante</h4>
            <label>Cantidad Muertos:</label><input type="number" id="cantidad_baja" placeholder="1">
            <label>Causa:</label><input type="text" id="causa_baja" placeholder="Ej. Aplastamiento">
        </div>

        <div id="section-destete" style="display:none;" class="special-section">
            <h4 style="margin:0 0 10px 0; color:#16a085;">Movimiento de Lechones</h4>
            <label>Cant. Destetados:</label><input type="number" id="destetados" onkeyup="generarInputsLechones()">
            <label style="color:red">üìç Destino Lechones (Fase):</label>
            <select id="subpuesto-lechones"></select>
            <div id="contenedor-inputs-lechones" style="margin-top:10px;"></div>
        </div>

        <label>Foto:</label>
        <button onclick="document.getElementById('inputFoto').click()" style="width:100%; padding:10px; background:#f8f9fa; border:1px solid #ddd; border-radius:8px;"><i class="fas fa-camera"></i> Tomar Foto</button>
        <input type="file" id="inputFoto" accept="image/*" capture="environment" style="display:none" onchange="previewFoto(this)">
        <img id="preview" class="preview-img">

        <label>Notas:</label>
        <input type="text" id="notas" placeholder="Observaciones adicionales">
        
        <button id="btnEnviar" class="btn-primary" onclick="enviarDatos()">Guardar üíæ</button>
    </div>
</div>

<div id="tab-reportes" class="tab-content">
    <div class="card-form">
        <h3>üìã Historial de Eventos</h3>
        <button onclick="window.location.href='reportes_avanzados.html'" class="btn-primary" style="background-color: #8e44ad; margin-bottom: 20px;">
            <i class="fas fa-chart-pie"></i> Ver Estad√≠sticas Avanzadas
        </button>
        <select id="filtro-reporte" onchange="cargarReportes()">
            <option value="TODOS">Ver Todos</option>
            <option value="VENTA">Ventas</option>
            <option value="MUERTE">Muertes</option>
            <option value="PARTO">Partos</option>
        </select>
        <div id="contenedor-reportes" style="margin-top:20px;"></div>
    </div>
</div>

<div class="nav-bar">
    <button class="nav-btn active" onclick="verTab('dashboard', this)"><i class="fas fa-th-large"></i></button>
    <button class="nav-btn" onclick="verTab('registro', this)"><i class="fas fa-plus-circle"></i></button>
    <button class="nav-btn" onclick="verTab('reportes', this)"><i class="fas fa-file-alt"></i></button>
</div>

<script>
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbw9euXc8iHBWtY6FwQUTw8tz17OXhdzhI_JziXHXN3Kj_1DWtMJ3As0AF71IcVXKNphRg/exec";
    
    let inventarioGlobal = [], historialCompleto = [], fotoBase64 = "", fotoMime = "";

    window.onload = () => {
        fetch(URL_SCRIPT).then(r => r.json()).then(data => {
            historialCompleto = data.registros;
            inventarioGlobal = procesarInventario(data.registros);
            
            procesarFases(data.fases);
            pintarDashboard(inventarioGlobal);
            
            // NUEVO: Llenar las listas de autocompletado
            llenarListasInteligentes(data.registros);

            document.getElementById('loader-dash').style.display='none';
            document.getElementById('view-dashboard-summary').style.display='block';
        });
    };

    // --- FUNCI√ìN PARA AUTOCOMPLETADO INTELIGENTE ---
    function llenarListasInteligentes(registros) {
        let subpuestos = new Set();
        let busqueda = new Set();

        registros.forEach(r => {
            // Columna 12 es Subpuesto
            if(r[12]) subpuestos.add(r[12].toString().toUpperCase().trim());
            
            // Columna 1 es Tatuaje(ID) y Columna 10 es Chapeta
            if(r[1]) busqueda.add(r[1].toString());
            if(r[10]) busqueda.add(r[10].toString());
        });

        // Llenar datalist de Subpuestos
        let listSub = document.getElementById('lista-subpuestos');
        listSub.innerHTML = Array.from(subpuestos).sort().map(s => `<option value="${s}">`).join('');

        // Llenar datalist de B√∫squeda Principal
        let listBus = document.getElementById('lista-busqueda');
        listBus.innerHTML = Array.from(busqueda).sort().map(s => `<option value="${s}">`).join('');
    }

    function verTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('tab-'+id).classList.add('active');
        if(btn) btn.classList.add('active');
        if(id === 'reportes') cargarReportes();
        if(id === 'registro') limpiarFormulario();
    }

    function procesarInventario(regs) {
        let estados = {};
        regs.forEach(r => {
            let id = r[1], acc = r[2], fase = r[3], fecha = r[0];
            if(!estados[id]) estados[id] = { id, piglets: 0, subpuesto: r[12], fase: fase, chapeta: r[10], madre: r[7], activo: true, fechaFase: fecha };
            
            if(acc === "VENTA" || acc === "MUERTE") estados[id].activo = false;
            else {
                estados[id].activo = true;
                let nuevaFase = fase.toUpperCase().trim().replace(/ /g, '_');
                if(estados[id].fase !== nuevaFase) { estados[id].fase = nuevaFase; estados[id].fechaFase = fecha; }
                estados[id].subpuesto = r[12]; estados[id].chapeta = r[10];

                if(acc === "PARTO") { 
                    let m = r[5].match(/Vivos: (\d+)/); 
                    if(m) estados[id].piglets = parseInt(m[1]);
                    estados[id].fechaFase = fecha; 
                }
                if(acc === "BAJA_LACTANCIA") {
                    let m = r[5].match(/Cantidad: (\d+)/);
                    if(m) estados[id].piglets = Math.max(0, estados[id].piglets - parseInt(m[1]));
                }
                if(acc === "DESTETE") { estados[id].piglets = 0; estados[id].fechaFase = fecha; }
            }
        });
        
        return Object.values(estados).filter(e => e.activo).map(e => {
            e.dias = calcularDias(e.fechaFase);
            e.color = obtenerColor(e.dias, e.fase);
            return e;
        });
    }

    function calcularDias(f) {
        if(!f) return 0;
        let diff = new Date() - new Date(f);
        return Math.floor(diff / (1000 * 60 * 60 * 24));
    }

    // --- REGLAS DE TIEMPO AJUSTADAS A TU TABLA ---
    function obtenerColor(dias, fase) {
        // SALA SERVICIO: Max 30 d√≠as
        if(fase.includes("SALA_SERVICIO")) {
            if(dias > 30) return "#e74c3c"; // Rojo (Pasado)
            if(dias > 25) return "#f1c40f"; // Amarillo (Alerta)
        }
        // GESTACION: Max 75 d√≠as (de estancia)
        if(fase.includes("GESTACION")) {
            if(dias > 75) return "#e74c3c";
            if(dias > 70) return "#f1c40f";
        }
        // MATERNIDAD: Max 35 d√≠as (de estancia)
        if(fase.includes("MATERNIDAD")) {
            if(dias > 35) return "#e74c3c";
            if(dias > 30) return "#f1c40f";
        }
        // DESCANSO: Max 6 d√≠as
        if(fase.includes("DESCANSO")) {
            if(dias > 6) return "#e74c3c";
            if(dias > 4) return "#f1c40f";
        }
        // PRECEBO (Est√°ndar 49 d√≠as)
        if(fase.includes("PRECEBO")) {
            if(dias > 49) return "#e74c3c";
            if(dias > 42) return "#f1c40f";
        }
        
        return "#2ecc71"; // Verde (Todo OK)
    }

    function pintarDashboard(inv) {
        let data = { total: 0, piglets: 0, phases: {} };
        inv.forEach(e => {
            data.total++;
            data.piglets += (e.piglets || 0);
            if (!data.phases[e.fase]) data.phases[e.fase] = { count: 0, alert: null };
            data.phases[e.fase].count++;
            if (e.color === "#e74c3c") data.phases[e.fase].alert = "red";
            else if (e.color === "#f1c40f" && data.phases[e.fase].alert !== "red") data.phases[e.fase].alert = "yellow";
        });
        
        let html = `<div class="card-dash card-maestra"><h3>POBLACI√ìN TOTAL</h3><h1>${data.total + data.piglets}</h1></div>`;
        html += `<div class="card-dash card-lechones" onclick="verLista('LECHONES')"><h3>LECHONES VIVOS</h3><h2>${data.piglets}</h2></div>`;
        
        Object.keys(data.phases).forEach(f => {
            let info = data.phases[f];
            let cl = f === "SALA_SERVICIO" ? "card-servicio" : "";
            let alertBadge = "";
            if (info.alert === "red") alertBadge = `<span class="alert-badge pulse-red"></span>`;
            else if (info.alert === "yellow") alertBadge = `<span class="alert-badge badge-yellow"></span>`;

            html += `<div class="card-dash ${cl}" onclick="verLista('${f}')">
                        ${alertBadge}
                        <h3>${f}</h3>
                        <h2>${info.count}</h2>
                     </div>`;
        });
        document.getElementById('dashboard-container').innerHTML = html;
    }

    function cargarReportes() {
        let f = document.getElementById('filtro-reporte').value;
        let lista = historialCompleto.filter(h => {
            let accion = h[2];
            let notas = h[5] || "";
            if (f === "TODOS") return true;
            if (f === "MUERTE") {
                if (accion === "MUERTE" || accion === "BAJA_LACTANCIA") return true;
                if (accion === "PARTO" && notas.includes("Muertos:") && !notas.includes("Muertos: 0")) return true;
                if (accion === "DESTETE" && notas.includes("Bajas:") && !notas.includes("Bajas: 0")) return true;
                return false;
            }
            return accion === f;
        });

        document.getElementById('contenedor-reportes').innerHTML = lista.reverse().map(h => {
            let fecha = new Date(h[0]).toLocaleDateString();
            let accion = h[2];
            let notas = h[5];
            let color = "#95a5a6";
            let icon = "fa-circle";

            if(accion === "VENTA") { color = "#27ae60"; icon = "fa-dollar-sign"; }
            else if(accion === "MUERTE" || accion === "BAJA_LACTANCIA") { color = "#c0392b"; icon = "fa-skull"; }
            else if(accion === "PARTO") { color = "#d35400"; icon = "fa-baby"; }
            else if(accion === "SERVICIO") { color = "#8e44ad"; icon = "fa-syringe"; }
            else if(accion === "DESTETE") { color = "#16a085"; icon = "fa-piggy-bank"; }
            else if(accion === "INGRESO") { color = "#2980b9"; icon = "fa-door-open"; }

            return `
            <div class="timeline-item">
                <div class="timeline-line"></div>
                <div class="timeline-icon" style="background-color:${color}"><i class="fas ${icon}"></i></div>
                <div class="timeline-content">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <b style="color:${color}; font-size:0.9rem;">${accion}</b>
                        <small style="color:#7f8c8d;">${fecha}</small>
                    </div>
                    <div style="font-weight:bold; font-size:1.1rem; color:#2c3e50;">ID: ${h[1]}</div>
                    <div style="font-size:0.9rem; color:#555; margin-top:5px;">${notas}</div>
                </div>
            </div>`;
        }).join("") || "<div style='text-align:center; padding:20px; color:#95a5a6;'>Sin registros encontrados.</div>";
    }

    function verLista(fase) {
        document.getElementById('view-dashboard-summary').style.display='none';
        document.getElementById('view-list').style.display='block';
        document.getElementById('titulo-lista').innerText = "En " + fase;
        let filtrados = (fase === 'LECHONES') ? inventarioGlobal.filter(e => e.piglets > 0) : inventarioGlobal.filter(e => e.fase === fase);
        
        document.getElementById('contenedor-lista').innerHTML = filtrados.map(e => `
            <div class="item-lista" onclick="verDetalle('${e.id}')" style="border-left: 5px solid ${e.color}">
                <div>
                    <b>ID: ${e.id}</b> <span class="dot-status" style="background-color:${e.color}"></span><br>
                    <small>üìç ${e.subpuesto || 'N/A'} | ‚è±Ô∏è ${e.dias} d√≠as ${e.piglets > 0 ? '| üê∑ '+e.piglets : ''}</small>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>
        `).join("") || "Vac√≠o";
    }

    function verDetalle(id) {
        let e = inventarioGlobal.find(x => x.id == id);
        document.getElementById('view-list').style.display='none';
        document.getElementById('view-detail').style.display='block';
        
        let botonExtra = '';
        if (e.piglets > 0) {
            botonExtra = `<button class="btn-action btn-destete" onclick="cargarAccion('${e.id}', 'DESTETE')"><i class="fas fa-baby-carriage"></i> Registrar Destete</button>`;
        } else if (e.fase === 'SALA_SERVICIO' || e.fase === 'GESTACION') {
            botonExtra = `<button class="btn-action btn-parto" onclick="cargarAccion('${e.id}', 'PARTO')"><i class="fas fa-piggy-bank"></i> Registrar Parto</button>`;
        }

        document.getElementById('contenedor-detalle').innerHTML = `
            <div class="card-form">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="margin:0;">ID: ${e.id}</h2>
                    <span style="background:${e.color}; color:white; padding:5px 10px; border-radius:15px; font-size:0.8rem;">‚è±Ô∏è ${e.dias} d√≠as</span>
                </div>
                <p>üìç <b>Puesto:</b> ${e.subpuesto || 'N/A'}</p>
                <p>üè∑Ô∏è <b>Chapeta:</b> ${e.chapeta || 'N/A'}</p>
                <p>üë©‚Äçüë¶ <b>Madre:</b> ${e.madre || 'N/A'}</p>
                ${e.piglets > 0 ? `
                    <div style="background:#fff3e0; padding:10px; border-radius:8px; border:1px solid #ffe0b2; margin:10px 0; display:flex; justify-content:space-between; align-items:center;">
                        <span style="color:#e67e22; font-weight:bold;">üê∑ ${e.piglets} Lechones Vivos</span>
                        <button class="btn-baja-lechon" onclick="cargarAccion('${e.id}', 'BAJA_LACTANCIA')">üíÄ Baja</button>
                    </div>` : ''}
                <div class="btn-action-group">
                    <button class="btn-action btn-orange" onclick="cargarAccion('${e.id}', 'OBSERVACION')"><i class="fas fa-edit"></i> Nota</button>
                    <button class="btn-action btn-blue" onclick="cargarAccion('${e.id}', 'TRASLADO')"><i class="fas fa-exchange-alt"></i> Mover</button>
                    <button class="btn-action btn-purple" onclick="cargarAccion('${e.id}', 'SERVICIO')"><i class="fas fa-syringe"></i> Inseminar</button>
                    ${botonExtra}
                </div>
                <hr><h4>Historial</h4>
                ${historialCompleto.filter(h=>h[1]==id).reverse().slice(0,10).map(h=>`<div style="font-size:0.8rem; margin-bottom:5px;">üìÖ ${new Date(h[0]).toLocaleDateString()} - <b>${h[2]}</b><br>${h[5]}</div>`).join("")}
            </div>
        `;
    }

    function cargarAccion(id, acc) { verTab('registro'); document.getElementById('tatuaje').value = id; document.getElementById('accion').value = acc; verificarAccion(); }

    function verificarAccion() {
        let acc = document.getElementById('accion').value;
        let tatId = document.getElementById('tatuaje').value;
        let animal = inventarioGlobal.find(a => a.id == tatId);

        document.getElementById('section-destete').style.display = "none";
        document.getElementById('section-parto').style.display = "none";
        document.getElementById('section-baja-lechon').style.display = "none";
        document.getElementById('section-fase').style.display = "block";
        document.getElementById('section-servicio').style.display = (acc === "SERVICIO") ? "block" : "none";

        if(acc === "SERVICIO") document.getElementById('fase').value = "SALA_SERVICIO";
        if(acc === "PARTO") { document.getElementById('fase').value = "MATERNIDAD"; document.getElementById('section-parto').style.display = "block"; }
        if(acc === "DESTETE") {
            document.getElementById('fase').value = "DESCANSO";
            document.getElementById('subpuesto-lechones').value = "PRECEBO"; 
            document.getElementById('section-destete').style.display = "block";
            if(animal) {
                document.getElementById('destetados').value = animal.piglets;
                generarInputsLechones();
            }
        }
        if(acc === "BAJA_LACTANCIA") {
            document.getElementById('fase').value = "MATERNIDAD"; 
            document.getElementById('section-baja-lechon').style.display = "block";
            document.getElementById('section-fase').style.display = "none";
        }
    }

    function procesarFases(f) { 
        let lista = ["SALA_SERVICIO", "GESTACION", "MATERNIDAD", "PRECEBO", "LEVANTE", "ENGORDE", "DESCANSO"].concat(f);
        let htmlOpciones = lista.map(x=>`<option value="${x}">${x}</option>`).join("");
        document.getElementById('fase').innerHTML = htmlOpciones;
        document.getElementById('subpuesto-lechones').innerHTML = htmlOpciones;
    }

    function agregarFase() {
        let n = prompt("Nombre de la nueva Ubicaci√≥n/Fase:");
        if(n && n.trim() !== "") {
            let val = n.toUpperCase().trim().replace(/ /g, '_');
            let o1 = document.createElement("option"); o1.text = val; o1.value = val; o1.selected = true; document.getElementById('fase').add(o1);
            let o2 = document.createElement("option"); o2.text = val; o2.value = val; document.getElementById('subpuesto-lechones').add(o2);
        }
    }

    function generarInputsLechones() {
        let c = parseInt(document.getElementById('destetados').value) || 0;
        document.getElementById('contenedor-inputs-lechones').innerHTML = `<div style="display:grid; grid-template-columns: 40px 1fr 1fr 40px; font-size:0.8rem; font-weight:bold; margin-bottom:5px;"><span>#</span><span>ID</span><span>Chap</span><span>OK</span></div>` + 
        Array.from({length:c}, (_,i)=>`<div class="lechon-item"><span>${i+1}</span><input type="text" class="l-tat" placeholder="ID"><input type="text" class="l-chap" placeholder="N¬∞"><input type="checkbox" class="l-status" checked></div>`).join("");
    }

    function previewFoto(f) {
        let r = new FileReader();
        r.onload = e => { fotoBase64 = e.target.result.split(",")[1]; fotoMime = f.files[0].type; document.getElementById('preview').src = e.target.result; document.getElementById('preview').style.display="block"; };
        r.readAsDataURL(f.files[0]);
    }

    function enviarDatos() {
        let acc = document.getElementById('accion').value;
        let id = document.getElementById('tatuaje').value;
        let animal = inventarioGlobal.find(a => a.id == id);

        if(acc === 'TRASLADO' && animal && animal.piglets > 0) {
            return alert("‚õî ERROR: No puedes mover a esta madre porque tiene lechones. Usa la opci√≥n de DESTETE.");
        }

        let btn = document.getElementById('btnEnviar'); btn.disabled = true; btn.innerText = "Guardando...";
        let d = { 
            tatuaje: id, 
            chapeta: document.getElementById('chapeta').value, 
            peso: document.getElementById('peso').value, 
            accion: acc, 
            fase: document.getElementById('fase').value, 
            subpuesto: document.getElementById('subpuesto').value, 
            notas: document.getElementById('notas').value, 
            inseminador: document.getElementById('inseminador').value,
            imagenBase64: fotoBase64, 
            mimeType: fotoMime 
        };

        if(acc === "DESTETE") {
            let subL = document.getElementById('subpuesto-lechones').value;
            if(!subL) { alert("Debes seleccionar el destino de los lechones"); btn.disabled = false; return; }
            let lechones = Array.from(document.querySelectorAll('.lechon-item')).filter(r => r.querySelector('.l-status').checked).map(r => ({ tatuaje: r.querySelector('.l-tat').value, chapeta: r.querySelector('.l-chap').value, notas: "Hijo de " + d.tatuaje })).filter(l=>l.tatuaje);
            let bajas = parseInt(document.getElementById('destetados').value) - lechones.length;
            d.notas = `DESTETE | Camada: ${document.getElementById('destetados').value} | Efectivos: ${lechones.length} | Bajas: ${bajas} ${d.notas}`;
            if(lechones.length > 0) fetch(URL_SCRIPT, { method:'POST', body: JSON.stringify({ tipo:"BATCH", comun:{ accion:"INGRESO", fase:"PRECEBO", subpuesto: subL, madre: d.tatuaje }, animales: lechones }) });
        }
        
        if(acc === "PARTO") {
            d.notas = `PARTO | Vivos: ${document.getElementById('vivos').value} | Muertos: ${document.getElementById('muertos').value} | Peso: ${document.getElementById('peso_nacimiento').value}kg ${d.notas}`;
        }
        
        if(acc === "BAJA_LACTANCIA") {
            let cant = document.getElementById('cantidad_baja').value || 1;
            let causa = document.getElementById('causa_baja').value || "Desconocida";
            d.notas = `BAJA LACTANCIA | Cantidad: ${cant} | Causa: ${causa} ${d.notas}`;
        }

        fetch(URL_SCRIPT, { method:'POST', body: JSON.stringify(d) }).then(() => location.reload());
    }

    function buscarCerdo() {
        let t = document.getElementById('inputBusqueda').value.toUpperCase();
        if(!t) { volverAlTablero(); return; }
        document.getElementById('view-dashboard-summary').style.display='none';
        document.getElementById('view-list').style.display='block';
        document.getElementById('contenedor-lista').innerHTML = inventarioGlobal.filter(e => e.id.toString().includes(t) || (e.chapeta && e.chapeta.toString().includes(t))).map(e => `<div class="item-lista" onclick="verDetalle('${e.id}')" style="border-left: 5px solid ${e.color}"><div><b>ID: ${e.id}</b> <span class="dot-status" style="background-color:${e.color}"></span><br><small>${e.fase}</small></div><i class="fas fa-chevron-right"></i></div>`).join("");
    }

    function limpiarFormulario() { 
        document.getElementById('tatuaje').value = ""; 
        document.getElementById('chapeta').value = ""; 
        document.getElementById('peso').value = ""; 
        document.getElementById('inseminador').value = ""; 
        document.getElementById('preview').style.display="none"; 
        fotoBase64=""; 
    }
    function cargarReportes() { 
        let f = document.getElementById('filtro-reporte').value;
        // ... (resto de funci√≥n cargarReportes igual que antes)
    }
    function volverAlTablero() { document.getElementById('view-list').style.display='none'; document.getElementById('view-dashboard-summary').style.display='block'; }
    function volverALista() { document.getElementById('view-detail').style.display='none'; document.getElementById('view-list').style.display='block'; }
</script>
</body>
</html>