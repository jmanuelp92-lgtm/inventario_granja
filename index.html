<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Granja Pro v4.10 üê∑</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- ESTILOS VISUALES ORIGINALES --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; margin: 0; padding-bottom: 90px; }
        header { background-color: #2c3e50; color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .search-container { padding: 10px 15px; background: #2c3e50; margin-bottom: 10px; }
        .search-box { width: 100%; padding: 12px; border-radius: 20px; border: none; font-size: 1rem; text-align: center; outline: none; }
        .tab-content { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        
        .grid-dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card-dash { background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; border-left: 5px solid transparent; }
        .card-maestra { grid-column: span 2; background: linear-gradient(135deg, #2c3e50, #34495e); color: white; }
        .card-lechones { background: linear-gradient(135deg, #f39c12, #d35400); color: white; }
        .card-servicio { background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white; }
        
        .card-dash h3 { margin: 0; font-size: 0.75rem; text-transform: uppercase; opacity: 0.8; }
        .card-dash h2 { margin: 10px 0 0 0; font-size: 2rem; }
        .card-dash h1 { margin: 5px 0 0 0; font-size: 3rem; }

        .card-form { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        label { display: block; font-weight: 600; margin-top: 15px; color: #34495e; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #bdc3c7; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn-primary { width: 100%; padding: 15px; background-color: #2980b9; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; margin-top: 25px; cursor: pointer; }
        
        .item-lista { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #2ecc71; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; }
        
        /* BOTONES DE ACCI√ìN */
        .btn-action-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn-action { padding: 12px; border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-orange { background-color: #e67e22; }
        .btn-blue { background-color: #2980b9; }
        .btn-purple { background-color: #8e44ad; grid-column: span 2; }
        /* Botones din√°micos grandes */
        .btn-parto { background-color: #d35400; grid-column: span 2; margin-top: 5px; }
        .btn-destete { background-color: #16a085; grid-column: span 2; margin-top: 5px; } /* Nuevo color verde azulado */

        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #eee; z-index: 100; }
        .nav-btn { background: none; border: none; font-size: 1.5rem; color: #bdc3c7; cursor: pointer; }
        .nav-btn.active { color: #2980b9; }

        .special-section { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #eee; }
        .preview-img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px; margin-top: 10px; display: none; }
        
        .lechon-item { display: grid; grid-template-columns: 40px 1fr 1fr 40px; gap: 5px; align-items: center; margin-top: 8px; background: white; padding: 5px; border-radius: 5px; border: 1px solid #eee; }
        .lechon-item input[type="checkbox"] { width: 20px; height: 20px; margin: 0 auto; cursor: pointer; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<header>
    <h2>üê∑ Granja Manager Pro</h2>
    <div class="search-container">
        <input type="text" id="inputBusqueda" class="search-box" placeholder="üîç Tatuaje o Chapeta..." onkeyup="buscarCerdo()">
    </div>
</header>

<div id="tab-dashboard" class="tab-content active">
    <div id="loader-dash" style="text-align:center; padding:40px;">‚è≥ Sincronizando datos...</div>
    <div id="view-dashboard-summary" style="display:none;">
        <div class="grid-dashboard" id="dashboard-container"></div>
    </div>

    <div id="view-list" style="display:none;">
        <button onclick="volverAlTablero()" style="border:none; background:none; color:#2980b9; font-weight:bold; margin-bottom:15px;"><i class="fas fa-arrow-left"></i> Volver</button>
        <h3 id="titulo-lista">Listado</h3>
        <div id="contenedor-lista"></div>
    </div>

    <div id="view-detail" style="display:none;">
        <button onclick="volverALista()" style="border:none; background:none; color:#2980b9; font-weight:bold; margin-bottom:15px;"><i class="fas fa-arrow-left"></i> Volver</button>
        <div id="contenedor-detalle"></div>
    </div>
</div>

<div id="tab-registro" class="tab-content">
    <div class="card-form">
        <h3>Nuevo Registro</h3>
        <label>Acci√≥n:</label>
        <select id="accion" onchange="verificarAccion()">
            <option value="INGRESO">üü¢ Ingreso</option>
            <option value="SERVICIO">üíâ SERVICIO</option>
            <option value="PARTO">üê∑ PARTO</option>
            <option value="DESTETE">ü•£ DESTETE</option>
            <option value="TRASLADO">üîµ Traslado</option>
            <option value="VENTA">üí∞ Venta</option>
            <option value="MUERTE">üî¥ Muerte</option>
            <option value="OBSERVACION">üìù Observaci√≥n / Peso</option>
        </select>

        <label>Tatuaje (ID):</label>
        <input type="text" id="tatuaje" placeholder="ID del animal">

        <div style="display:flex; gap:10px;">
            <div style="flex:1;"><label>Chapeta:</label><input type="text" id="chapeta" placeholder="N¬∞"></div>
            <div style="flex:1;"><label>Peso (kg):</label><input type="number" id="peso" placeholder="0.0"></div>
        </div>

        <div id="section-fase">
            <label>Ubicaci√≥n / Fase:</label>
            <div style="display:flex; gap:5px;">
                <select id="fase" style="flex:1"></select>
                <button class="btn-blue" onclick="agregarFase()" style="width:50px; margin-top:5px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:1.2rem;">+</button>
            </div>
            <label>Sub-Puesto (Jaula/Corral):</label>
            <input type="text" id="subpuesto" placeholder="Donde se encuentra">
        </div>

        <div id="section-parto" style="display:none;" class="special-section">
            <h4 style="margin:0 0 10px 0; color:#d35400;">Registro de Camada</h4>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Vivos:</label><input type="number" id="vivos" placeholder="0"></div>
                <div style="flex:1;"><label>Muertos:</label><input type="number" id="muertos" placeholder="0"></div>
            </div>
            <label>Peso Total Nacimiento:</label><input type="number" id="peso_nacimiento" placeholder="0.0">
        </div>

        <div id="section-destete" style="display:none;" class="special-section">
            <h4 style="margin:0 0 10px 0; color:#16a085;">Movimiento de Lechones</h4>
            <label>Cant. Destetados:</label><input type="number" id="destetados" onkeyup="generarInputsLechones()">
            
            <label style="color:red">üìç Destino Lechones (Fase):</label>
            <select id="subpuesto-lechones"></select>
            
            <div id="contenedor-inputs-lechones" style="margin-top:10px;"></div>
        </div>

        <label>Foto:</label>
        <button onclick="document.getElementById('inputFoto').click()" style="width:100%; padding:10px; background:#f8f9fa; border:1px solid #ddd; border-radius:8px;"><i class="fas fa-camera"></i> Tomar Foto</button>
        <input type="file" id="inputFoto" accept="image/*" capture="environment" style="display:none" onchange="previewFoto(this)">
        <img id="preview" class="preview-img">

        <label>Notas:</label>
        <input type="text" id="notas" placeholder="Observaciones adicionales">
        
        <button id="btnEnviar" class="btn-primary" onclick="enviarDatos()">Guardar üíæ</button>
    </div>
</div>

<div id="tab-reportes" class="tab-content">
    <div class="card-form">
        <h3>üìã Historial de Salidas</h3>
        <select id="filtro-reporte" onchange="cargarReportes()">
            <option value="TODOS">Ver Todos</option>
            <option value="VENTA">Ventas</option>
            <option value="MUERTE">Muertes</option>
        </select>
        <div id="contenedor-reportes" style="margin-top:15px;"></div>
    </div>
</div>

<div class="nav-bar">
    <button class="nav-btn active" onclick="verTab('dashboard', this)"><i class="fas fa-th-large"></i></button>
    <button class="nav-btn" onclick="verTab('registro', this)"><i class="fas fa-plus-circle"></i></button>
    <button class="nav-btn" onclick="verTab('reportes', this)"><i class="fas fa-file-alt"></i></button>
</div>

<script>
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbzGSrL_Xz9NSbF0aILVx89F1DPeZKn65bOYdhidzUzTMLq6decnT-D6kR-j1mhKOvnTdg/exec";
    let inventarioGlobal = [], historialCompleto = [], fotoBase64 = "", fotoMime = "";

    window.onload = () => {
        fetch(URL_SCRIPT).then(r => r.json()).then(data => {
            historialCompleto = data.registros;
            inventarioGlobal = procesarInventario(data.registros);
            procesarFases(data.fases);
            pintarDashboard(inventarioGlobal);
            document.getElementById('loader-dash').style.display='none';
            document.getElementById('view-dashboard-summary').style.display='block';
        });
    };

    function verTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('tab-'+id).classList.add('active');
        if(btn) btn.classList.add('active');
        if(id === 'reportes') cargarReportes();
        if(id === 'registro') limpiarFormulario();
    }

    function procesarInventario(regs) {
        let estados = {};
        regs.forEach(r => {
            let id = r[1], acc = r[2], fase = r[3];
            if(!estados[id]) estados[id] = { id, piglets: 0, subpuesto: r[12], fase: fase, chapeta: r[10], madre: r[7], activo: true };
            if(acc === "VENTA" || acc === "MUERTE") estados[id].activo = false;
            else {
                estados[id].activo = true; 
                estados[id].fase = fase.toUpperCase().trim().replace(/ /g, '_'); 
                estados[id].subpuesto = r[12]; estados[id].chapeta = r[10];
                if(acc === "PARTO") { 
                    let m = r[5].match(/Vivos: (\d+)/); 
                    if(m) estados[id].piglets = parseInt(m[1]); 
                }
                if(acc === "DESTETE") estados[id].piglets = 0;
            }
        });
        return Object.values(estados).filter(e => e.activo);
    }

    function pintarDashboard(inv) {
        let counts = inv.reduce((a,b) => { a[b.fase] = (a[b.fase]||0)+1; a.total++; a.piglets += (b.piglets||0); return a; }, {total:0, piglets:0});
        
        let html = `<div class="card-dash card-maestra"><h3>POBLACI√ìN TOTAL</h3><h1>${counts.total + counts.piglets}</h1></div>`;
        html += `<div class="card-dash card-lechones" onclick="verLista('LECHONES')"><h3>LECHONES VIVOS</h3><h2>${counts.piglets}</h2></div>`;
        
        Object.keys(counts).filter(k=>k!=="total" && k!=="piglets").forEach(f => {
            let cl = f === "SALA_SERVICIO" ? "card-servicio" : "";
            html += `<div class="card-dash ${cl}" onclick="verLista('${f}')"><h3>${f}</h3><h2>${counts[f]}</h2></div>`;
        });
        document.getElementById('dashboard-container').innerHTML = html;
    }

    function verLista(fase) {
        document.getElementById('view-dashboard-summary').style.display='none';
        document.getElementById('view-list').style.display='block';
        document.getElementById('titulo-lista').innerText = "En " + fase;
        let filtrados = (fase === 'LECHONES') ? inventarioGlobal.filter(e => e.piglets > 0) : inventarioGlobal.filter(e => e.fase === fase);
        
        document.getElementById('contenedor-lista').innerHTML = filtrados.map(e => `
            <div class="item-lista" onclick="verDetalle('${e.id}')"><div><b>${e.id}</b><br><small>üìç ${e.subpuesto || 'Sin puesto'} ${e.piglets > 0 ? '| üê∑ '+e.piglets : ''}</small></div><i class="fas fa-chevron-right"></i></div>
        `).join("") || "Vac√≠o";
    }

    function verDetalle(id) {
        let e = inventarioGlobal.find(x => x.id == id);
        document.getElementById('view-list').style.display='none';
        document.getElementById('view-detail').style.display='block';
        
        // --- L√ìGICA DE BOTONES DIN√ÅMICOS ---
        // Si tiene lechones > 0, mostramos DESTETE. Si no, y est√° en gestaci√≥n, mostramos PARTO.
        let botonExtra = '';
        if (e.piglets > 0) {
            botonExtra = `<button class="btn-action btn-destete" onclick="cargarAccion('${e.id}', 'DESTETE')"><i class="fas fa-baby-carriage"></i> Registrar Destete</button>`;
        } else if (e.fase === 'SALA_SERVICIO' || e.fase === 'GESTACION') {
            botonExtra = `<button class="btn-action btn-parto" onclick="cargarAccion('${e.id}', 'PARTO')"><i class="fas fa-piggy-bank"></i> Registrar Parto</button>`;
        }

        document.getElementById('contenedor-detalle').innerHTML = `
            <div class="card-form">
                <h2 style="margin:0;">ID: ${e.id}</h2>
                <p>üìç <b>Puesto:</b> ${e.subpuesto || 'N/A'}</p>
                <p>üè∑Ô∏è <b>Chapeta:</b> ${e.chapeta || 'N/A'}</p>
                <p>üë©‚Äçüë¶ <b>Madre:</b> ${e.madre || 'N/A'}</p>
                ${e.piglets > 0 ? `<p style="color:#e67e22; font-weight:bold;">üê∑ Lechones activos: ${e.piglets}</p>` : ''}
                
                <div class="btn-action-group">
                    <button class="btn-action btn-orange" onclick="cargarAccion('${e.id}', 'OBSERVACION')"><i class="fas fa-edit"></i> Nota</button>
                    <button class="btn-action btn-blue" onclick="cargarAccion('${e.id}', 'TRASLADO')"><i class="fas fa-exchange-alt"></i> Mover</button>
                    <button class="btn-action btn-purple" onclick="cargarAccion('${e.id}', 'SERVICIO')"><i class="fas fa-syringe"></i> Inseminar</button>
                    ${botonExtra}
                </div>
                <hr><h4>Historial</h4>
                ${historialCompleto.filter(h=>h[1]==id).reverse().slice(0,10).map(h=>`<div style="font-size:0.8rem; margin-bottom:5px;">üìÖ ${new Date(h[0]).toLocaleDateString()} - <b>${h[2]}</b><br>${h[5]}</div>`).join("")}
            </div>
        `;
    }

    function cargarAccion(id, acc) { verTab('registro'); document.getElementById('tatuaje').value = id; document.getElementById('accion').value = acc; verificarAccion(); }

    function verificarAccion() {
        let acc = document.getElementById('accion').value;
        let tatId = document.getElementById('tatuaje').value;
        let animal = inventarioGlobal.find(a => a.id == tatId);

        document.getElementById('section-destete').style.display = (acc === "DESTETE") ? "block" : "none";
        document.getElementById('section-parto').style.display = (acc === "PARTO") ? "block" : "none";
        
        if(acc === "SERVICIO") document.getElementById('fase').value = "SALA_SERVICIO";
        if(acc === "PARTO") document.getElementById('fase').value = "MATERNIDAD";
        if(acc === "DESTETE") {
            document.getElementById('fase').value = "DESCANSO";
            document.getElementById('subpuesto-lechones').value = "PRECEBO"; 
            if(animal) {
                // Rellena autom√°ticamente la cantidad de lechones que tiene registrados
                document.getElementById('destetados').value = animal.piglets;
                generarInputsLechones();
            }
        }
    }

    function procesarFases(f) { 
        let lista = ["SALA_SERVICIO", "GESTACION", "MATERNIDAD", "PRECEBO", "LEVANTE", "ENGORDE", "DESCANSO"].concat(f);
        let htmlOpciones = lista.map(x=>`<option value="${x}">${x}</option>`).join("");
        document.getElementById('fase').innerHTML = htmlOpciones;
        document.getElementById('subpuesto-lechones').innerHTML = htmlOpciones;
    }

    function agregarFase() {
        let n = prompt("Nombre de la nueva Ubicaci√≥n/Fase:");
        if(n && n.trim() !== "") {
            let val = n.toUpperCase().trim().replace(/ /g, '_');
            let o1 = document.createElement("option"); o1.text = val; o1.value = val; o1.selected = true; document.getElementById('fase').add(o1);
            let o2 = document.createElement("option"); o2.text = val; o2.value = val; document.getElementById('subpuesto-lechones').add(o2);
        }
    }

    function generarInputsLechones() {
        let c = parseInt(document.getElementById('destetados').value) || 0;
        document.getElementById('contenedor-inputs-lechones').innerHTML = `<div style="display:grid; grid-template-columns: 40px 1fr 1fr 40px; font-size:0.8rem; font-weight:bold; margin-bottom:5px;"><span>#</span><span>ID</span><span>Chap</span><span>OK</span></div>` + 
        Array.from({length:c}, (_,i)=>`<div class="lechon-item"><span>${i+1}</span><input type="text" class="l-tat" placeholder="ID"><input type="text" class="l-chap" placeholder="N¬∞"><input type="checkbox" class="l-status" checked></div>`).join("");
    }

    function previewFoto(f) {
        let r = new FileReader();
        r.onload = e => { fotoBase64 = e.target.result.split(",")[1]; fotoMime = f.files[0].type; document.getElementById('preview').src = e.target.result; document.getElementById('preview').style.display="block"; };
        r.readAsDataURL(f.files[0]);
    }

    function enviarDatos() {
        let acc = document.getElementById('accion').value;
        let id = document.getElementById('tatuaje').value;
        let animal = inventarioGlobal.find(a => a.id == id);

        if(acc === 'TRASLADO' && animal && animal.piglets > 0) {
            return alert("‚õî ERROR: No puedes mover a esta madre porque tiene lechones. Usa la opci√≥n de DESTETE.");
        }

        let btn = document.getElementById('btnEnviar'); btn.disabled = true; btn.innerText = "Guardando...";
        let d = { tatuaje: id, chapeta: document.getElementById('chapeta').value, peso: document.getElementById('peso').value, accion: acc, fase: document.getElementById('fase').value, subpuesto: document.getElementById('subpuesto').value, notas: document.getElementById('notas').value, imagenBase64: fotoBase64, mimeType: fotoMime };

        if(acc === "DESTETE") {
            let subL = document.getElementById('subpuesto-lechones').value;
            if(!subL) { alert("Debes seleccionar el destino de los lechones"); btn.disabled = false; return; }
            
            let lechones = Array.from(document.querySelectorAll('.lechon-item')).filter(r => r.querySelector('.l-status').checked).map(r => ({ tatuaje: r.querySelector('.l-tat').value, chapeta: r.querySelector('.l-chap').value, notas: "Hijo de " + d.tatuaje })).filter(l=>l.tatuaje);
            let bajas = parseInt(document.getElementById('destetados').value) - lechones.length;
            d.notas = `DESTETE | Camada: ${document.getElementById('destetados').value} | Efectivos: ${lechones.length} | Bajas: ${bajas} ${d.notas}`;
            if(lechones.length > 0) fetch(URL_SCRIPT, { method:'POST', body: JSON.stringify({ tipo:"BATCH", comun:{ accion:"INGRESO", fase:"PRECEBO", subpuesto: subL, madre: d.tatuaje }, animales: lechones }) });
        }
        
        if(acc === "PARTO") {
            d.notas = `PARTO | Vivos: ${document.getElementById('vivos').value} | Muertos: ${document.getElementById('muertos').value} | Peso: ${document.getElementById('peso_nacimiento').value}kg ${d.notas}`;
        }

        fetch(URL_SCRIPT, { method:'POST', body: JSON.stringify(d) }).then(() => location.reload());
    }

    function buscarCerdo() {
        let t = document.getElementById('inputBusqueda').value.toUpperCase();
        if(!t) { volverAlTablero(); return; }
        document.getElementById('view-dashboard-summary').style.display='none';
        document.getElementById('view-list').style.display='block';
        document.getElementById('contenedor-lista').innerHTML = inventarioGlobal.filter(e => e.id.toString().includes(t) || (e.chapeta && e.chapeta.toString().includes(t))).map(e => `<div class="item-lista" onclick="verDetalle('${e.id}')"><div><b>ID: ${e.id}</b><br><small>${e.fase}</small></div><i class="fas fa-chevron-right"></i></div>`).join("");
    }

    function limpiarFormulario() { document.getElementById('tatuaje').value = ""; document.getElementById('chapeta').value = ""; document.getElementById('peso').value = ""; document.getElementById('preview').style.display="none"; fotoBase64=""; }
    function cargarReportes() { let f = document.getElementById('filtro-reporte').value; document.getElementById('contenedor-reportes').innerHTML = historialCompleto.filter(h => f === "TODOS" || h[2] === f).reverse().map(h => `<div class="item-lista"><div><b>${h[1]}</b> - ${h[2]}<br><small>${new Date(h[0]).toLocaleDateString()} - ${h[5]}</small></div></div>`).join("") || "Sin registros."; }
    function volverAlTablero() { document.getElementById('view-list').style.display='none'; document.getElementById('view-dashboard-summary').style.display='block'; }
    function volverALista() { document.getElementById('view-detail').style.display='none'; document.getElementById('view-list').style.display='block'; }
</script>
</body>
</html>