<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Granja Manager Pro üîç</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ESTILOS BASE */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding-bottom: 90px; }
        header { background-color: #2c3e50; color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* BUSCADOR */
        .search-container { padding: 10px 15px; background: #2c3e50; margin-bottom: 10px; }
        .search-box { width: 100%; padding: 10px; border-radius: 20px; border: none; font-size: 1rem; text-align: center; outline: none; }

        /* VISTAS */
        .tab-content { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        .sub-view { display: none; } 

        /* DASHBOARD */
        .grid-dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card-dash { background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; position: relative; }
        .card-dash:active { transform: scale(0.98); }
        .card-dash h3 { margin: 0; font-size: 0.75rem; color: #7f8c8d; text-transform: uppercase; }
        .card-dash h2 { margin: 10px 0 0 0; font-size: 2rem; color: #2c3e50; }
        .card-total { grid-column: span 2; background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; }
        .card-total h2, .card-total h3 { color: white !important; }

        /* FORMULARIO */
        .card-form { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        label { display: block; font-weight: 600; margin-top: 15px; color: #34495e; font-size: 0.95rem; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #bdc3c7; border-radius: 8px; box-sizing: border-box; background: #fff; font-size: 16px; }
        
        .input-group { display: flex; gap: 10px; align-items: flex-end; }
        .btn-add { background: #27ae60; color: white; border: none; padding: 12px 15px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; height: 46px; margin-top: 5px; }
        
        /* BOTONES */
        button.btn-primary { width: 100%; padding: 15px; background-color: #2980b9; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; margin-top: 25px; cursor: pointer; }
        .btn-edit { background-color: #f39c12; color: white; padding: 10px; width: 100%; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin-top:10px; }
        
        /* LISTAS */
        .item-lista { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; }
        
        /* NAVEGACI√ìN */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #eee; z-index: 90; }
        .nav-btn { background: none; border: none; font-size: 1.5rem; color: #bdc3c7; display: flex; flex-direction: column; align-items: center; }
        .nav-btn.active { color: #2980b9; }
        .btn-back { background: none; border: none; color: #2980b9; font-size: 1rem; cursor: pointer; margin-bottom: 15px; display: flex; align-items: center; gap: 5px; font-weight: 600; }
        .loader { text-align: center; padding: 20px; display: none; color: #7f8c8d; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<header>
    <h2>üê∑ Granja Manager</h2>
    <div class="search-container" id="search-bar-container" style="display:none;">
        <input type="text" id="inputBusqueda" class="search-box" placeholder="üîç Buscar Chapeta o ID..." onkeyup="buscarCerdo()">
    </div>
</header>

<div id="tab-dashboard" class="tab-content active">
    <div class="loader" id="loader-dash">‚è≥ Cargando...</div>
    
    <div id="view-dashboard-summary" style="display:none;">
        <div class="grid-dashboard" id="dashboard-container">
            </div>
        <div style="text-align:center; margin-top: 30px;">
            <button onclick="location.reload()" style="background:none; border:none; color:#2980b9; font-weight:bold;">üîÑ Actualizar</button>
        </div>
    </div>

    <div id="view-list" class="sub-view">
        <button class="btn-back" onclick="volverAlTablero()"><i class="fas fa-arrow-left"></i> Volver</button>
        <h2 id="titulo-lista" style="color:#2c3e50; border-bottom: 2px solid #2ecc71; padding-bottom: 10px;">Listado</h2>
        <div id="contenedor-lista"></div>
    </div>

    <div id="view-detail" class="sub-view">
        <button class="btn-back" onclick="volverALista()"><i class="fas fa-arrow-left"></i> Volver</button>
        <div id="contenedor-detalle" class="card-form"></div>
    </div>
</div>

<div id="tab-registro" class="tab-content">
    <div class="card-form">
        <h3 id="titulo-form" style="margin-top:0; color:#2c3e50;">Nuevo Movimiento</h3>

        <label>Chapeta (ID):</label>
        <input type="number" id="chapeta" placeholder="Ej. 504" inputmode="numeric">

        <label>Acci√≥n:</label>
        <select id="accion" onchange="verificarAccion()">
            <option value="INGRESO">üü¢ Nacimiento / Compra</option>
            <option value="TRASLADO">üîµ Traslado / Correcci√≥n</option>
            <option value="VENTA">üí∞ Venta</option>
            <option value="MUERTE">üî¥ Muerte / Baja</option>
        </select>

        <label>Ubicaci√≥n / Fase Nueva:</label>
        <div class="input-group">
            <select id="fase">
                </select>
            <button class="btn-add" onclick="agregarNuevaFase()">+</button>
        </div>

        <label>Genealog√≠a:</label>
        <div style="display:flex; gap:10px;">
             <select id="madre" style="flex:1"><option value="">Madre</option></select>
             <input type="text" id="padre" placeholder="Padre" style="flex:1; margin-top:5px;">
        </div>

        <div style="margin-top:15px; display:flex; align-items:center; gap:10px;">
             <input type="checkbox" id="esReproductora" style="width:20px; height:20px;">
             <label style="margin:0;">Es Futura Madre</label>
        </div>

        <label>Notas / Peso:</label>
        <input type="text" id="notas" placeholder="Peso, observaciones...">
        
        <div class="file-upload-wrapper" id="drop-zone" onclick="document.getElementById('fotoInput').click()" style="margin-top:15px; border:2px dashed #ccc; padding:15px; text-align:center;">
            <div id="text-foto">üì∏ Toca para foto</div>
            <input type="file" id="fotoInput" accept="image/*" capture="environment" onchange="procesarFoto()" style="display:none;">
        </div>

        <button id="btnEnviar" class="btn-primary" onclick="enviarDatos()">Guardar Registro üíæ</button>
    </div>
</div>

<div class="nav-bar">
    <button class="nav-btn active" onclick="verTab('dashboard', this)"><span>üìä</span><span>Tablero</span></button>
    <button class="nav-btn" onclick="verTab('registro', this)"><span>‚ûï</span><span>Registrar</span></button>
</div>

<script>
    // --- TU URL DE GOOGLE APPS SCRIPT ---
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycby_sbcvFYmbDdzhoqCwaWxI1nM90c_z92g1xzWuKMOAmS0-UITWccD7XAoeatM8KVpRZQ/exec";

    let inventarioGlobal = []; 
    let fasesGlobales = [];
    let imagenBase64 = ""; 
    let categoriaActual = "";

    window.onload = cargarDatos;

    function verTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(d => d.style.display='none');
        document.getElementById('tab-'+tabId).style.display='block';
        if(btn) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        // Mostrar buscador solo en dashboard
        if(tabId === 'dashboard') {
            document.getElementById('search-bar-container').style.display = 'block';
            document.getElementById('titulo-form').innerText = "Nuevo Movimiento";
            limpiarFormulario(); // Limpiar si vienes de editar
        } else {
            document.getElementById('search-bar-container').style.display = 'none';
        }
    }

    // --- CARGA DE DATOS ---
    function cargarDatos() {
        document.getElementById('loader-dash').style.display='block';
        fetch(URL_SCRIPT)
            .then(r => r.json())
            .then(data => {
                let registros = data.registros || (Array.isArray(data) ? data : []);
                let fases = data.fases || [];
                procesarFases(fases);
                procesarMadres(registros);
                procesarDashboard(registros);
                document.getElementById('loader-dash').style.display='none';
                document.getElementById('view-dashboard-summary').style.display='block';
                document.getElementById('search-bar-container').style.display='block';
            })
            .catch(e => {
                console.error(e);
                alert("Error de conexi√≥n. Revisa que el script sea 'Cualquier persona'");
            });
    }

    // --- BUSCADOR (NUEVO) ---
    function buscarCerdo() {
        let texto = document.getElementById('inputBusqueda').value.toUpperCase();
        
        if (texto.length === 0) {
            // Si borran, volver al dashboard
            document.getElementById('view-dashboard-summary').style.display = 'block';
            document.getElementById('view-list').style.display = 'none';
            return;
        }

        // Filtrar
        let resultados = inventarioGlobal.filter(a => a.id.toString().includes(texto));
        
        // Mostrar vista lista forzada
        document.getElementById('view-dashboard-summary').style.display = 'none';
        document.getElementById('view-list').style.display = 'block';
        document.getElementById('view-detail').style.display = 'none';
        document.getElementById('titulo-lista').innerText = `Resultados: ${resultados.length}`;
        
        pintarLista(resultados);
    }

    // --- DASHBOARD Y L√ìGICA DE ESTADO ---
    function procesarDashboard(data) {
        let counts = { TOTAL: 0 };
        let estados = {};

        // Recorremos cronol√≥gicamente: el √∫ltimo registro sobreescribe el estado
        data.forEach(fila => {
            let id = fila[1], acc = fila[2], fase = fila[3];
            // Inicializamos o actualizamos
            if(!estados[id]) estados[id] = {};
            
            // Guardamos datos m√°s recientes
            estados[id].id = id;
            estados[id].notas = fila[5];
            estados[id].padre = fila[6]; // Padre
            estados[id].madre = fila[7]; // Madre
            estados[id].esRepro = fila[8];
            estados[id].foto = fila[9];

            if(acc === 'VENTA' || acc === 'MUERTE') {
                estados[id].status = 'OFF';
                estados[id].fase = 'FUERA';
            } else {
                estados[id].status = 'ON';
                estados[id].fase = fase ? fase.toUpperCase().trim() : "SIN_CATEGORIA";
            }
        });

        // Convertimos el objeto estados a lista limpia
        inventarioGlobal = [];
        for(let id in estados) {
            let animal = estados[id];
            if(animal.status === 'ON') {
                counts.TOTAL++;
                let f = animal.fase;
                if(!counts[f]) counts[f] = 0;
                counts[f]++;
                inventarioGlobal.push(animal);
            }
        }

        // Renderizar Tablero
        const container = document.getElementById('dashboard-container');
        container.innerHTML = `<div class="card-dash card-total"><h3>Total</h3><h2>${counts.TOTAL}</h2></div>`;

        let fasesAMostrar = new Set([...Array.from(document.getElementById('fase').options).map(o=>o.value), ...Object.keys(counts)]);
        fasesAMostrar.delete("TOTAL"); fasesAMostrar.delete("FUERA"); fasesAMostrar.delete("");

        fasesAMostrar.forEach(fase => {
            let cant = counts[fase] || 0;
            container.innerHTML += `<div class="card-dash" onclick="verLista('${fase}')"><h3>${fase}</h3><h2>${cant}</h2></div>`;
        });
    }

    // --- LISTAS Y DETALLES ---
    function verLista(categoria) {
        categoriaActual = categoria;
        document.getElementById('view-dashboard-summary').style.display = 'none';
        document.getElementById('view-list').style.display = 'block';
        document.getElementById('titulo-lista').innerText = "En: " + categoria;
        
        let filtrados = inventarioGlobal.filter(a => a.fase === categoria);
        pintarLista(filtrados);
    }

    function pintarLista(lista) {
        const cont = document.getElementById('contenedor-lista');
        cont.innerHTML = "";
        if(lista.length === 0) { cont.innerHTML = "<p style='text-align:center'>No hay resultados</p>"; return; }

        lista.forEach(animal => {
            let div = document.createElement('div');
            div.className = 'item-lista';
            div.innerHTML = `<div><strong>üê∑ ${animal.id}</strong><br><small>${animal.notas || ''}</small></div><i class="fas fa-chevron-right"></i>`;
            div.onclick = () => verDetalle(animal.id);
            cont.appendChild(div);
        });
    }

    function verDetalle(id) {
        let animal = inventarioGlobal.find(a => a.id == id);
        if (!animal) return; // Por si acaso

        document.getElementById('view-list').style.display = 'none';
        document.getElementById('view-detail').style.display = 'block';
        
        let html = `
            <div style="text-align:center">
                <h1 style="margin:0">${animal.id}</h1>
                <span style="background:#2ecc71;color:white;padding:2px 8px;border-radius:10px;font-size:0.8rem">${animal.fase}</span>
            </div>
            <hr>
            <p><strong>Madre:</strong> ${animal.madre || '-'} | <strong>Padre:</strong> ${animal.padre || '-'}</p>
            <p><strong>Notas:</strong> ${animal.notas || '-'}</p>
        `;
        
        if(animal.foto && animal.foto.includes("http")) {
            html += `<img src="${animal.foto}" style="width:100%; border-radius:10px; margin-top:10px;">`;
        }

        // --- BOT√ìN DE EDITAR / TRASLADAR ---
        html += `
            <div style="margin-top:20px;">
                <button class="btn-edit" onclick="cargarParaEditar('${animal.id}')">
                    ‚úèÔ∏è Editar / Trasladar
                </button>
            </div>
        `;
        
        document.getElementById('contenedor-detalle').innerHTML = html;
    }

    // --- FUNCI√ìN DE EDICI√ìN / TRASLADO (NUEVO) ---
    function cargarParaEditar(id) {
        let animal = inventarioGlobal.find(a => a.id == id);
        
        // 1. Ir a la pesta√±a registro
        verTab('registro', document.querySelectorAll('.nav-btn')[1]);
        
        // 2. Cambiar t√≠tulo para que sepa que est√° editando
        document.getElementById('titulo-form').innerText = "Editar / Trasladar Cerdo " + id;
        
        // 3. Llenar los datos
        document.getElementById('chapeta').value = animal.id;
        // Bloquear ID para no crear otro cerdo por error
        document.getElementById('chapeta').readOnly = true; 
        document.getElementById('chapeta').style.backgroundColor = "#eee";

        document.getElementById('accion').value = "TRASLADO"; // Por defecto sugerimos traslado
        document.getElementById('fase').value = animal.fase;
        document.getElementById('notas').value = animal.notas;
        document.getElementById('padre').value = animal.padre;
        document.getElementById('madre').value = animal.madre;
        document.getElementById('esReproductora').checked = (animal.esRepro === "SI");

        alert("Modifica la FASE o los DATOS y guarda para actualizar.");
    }

    function limpiarFormulario() {
        document.getElementById('chapeta').value = "";
        document.getElementById('chapeta').readOnly = false;
        document.getElementById('chapeta').style.backgroundColor = "white";
        document.getElementById('accion').value = "INGRESO";
        document.getElementById('notas').value = "";
        document.getElementById('titulo-form').innerText = "Nuevo Movimiento";
    }

    // --- FASES, MADRES Y ENV√çO ---
    function procesarFases(lista) {
        const sel = document.getElementById('fase');
        sel.innerHTML = "";
        let base = lista && lista.length ? lista : ['PARIDERA','PRECEBO','LEVANTE','ENGORDE'];
        base.forEach(f => {
            let opt = document.createElement('option');
            opt.value = f.toUpperCase(); opt.text = f; sel.add(opt);
        });
        let optF = document.createElement('option'); optF.value = "FUERA"; optF.text = "Fuera"; sel.add(optF);
    }
    
    function agregarNuevaFase() {
        let n = prompt("Nueva fase:"); if(!n) return;
        n = n.toUpperCase().trim();
        let sel = document.getElementById('fase');
        let opt = document.createElement('option'); opt.value = n; opt.text = n;
        sel.add(opt, sel.options[sel.length-1]); sel.value = n;
        fetch(URL_SCRIPT, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tipo:"NUEVA_FASE", nombre:n})});
    }

    function procesarMadres(reg) {
        let sel = document.getElementById('madre');
        sel.innerHTML = '<option value="">Madre</option><option value="NA">N/A</option>';
        let m = new Set();
        reg.forEach(r => { if(r[8]==='SI') m.add(r[1]); });
        m.forEach(x => { let o = document.createElement('option'); o.value=x; o.text="Madre "+x; sel.add(o); });
    }

    function procesarFoto() {
        let f = document.getElementById('fotoInput').files[0]; if(!f)return;
        let r = new FileReader(); r.readAsDataURL(f);
        r.onload = e => {
            let i = new Image(); i.src = e.target.result;
            i.onload = () => {
                let c = document.createElement("canvas");
                let s = 800/i.width; c.width=800; c.height=i.height*s;
                c.getContext("2d").drawImage(i,0,0,c.width,c.height);
                imagenBase64 = c.toDataURL("image/jpeg",0.6).split(",")[1];
                document.getElementById('text-foto').innerText = "‚úÖ Foto OK";
            }
        }
    }

    function enviarDatos() {
        let btn = document.getElementById('btnEnviar');
        let d = {
            chapeta: document.getElementById('chapeta').value,
            accion: document.getElementById('accion').value,
            fase: document.getElementById('fase').value,
            ubicacion: document.getElementById('fase').value,
            notas: document.getElementById('notas').value,
            padre: document.getElementById('padre').value,
            madre: document.getElementById('madre').value,
            esReproductora: document.getElementById('esReproductora').checked ? "SI" : "NO",
            imagenBase64: imagenBase64,
            mimeType: "image/jpeg"
        };
        if(!d.chapeta) return alert("Falta ID");
        btn.disabled = true; btn.innerText = "Guardando...";
        fetch(URL_SCRIPT, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)})
        .then(() => { alert("Guardado"); location.reload(); })
        .catch(() => { alert("Error"); btn.disabled = false; });
    }

    function verificarAccion() {
        if(['VENTA','MUERTE'].includes(document.getElementById('accion').value)) 
            document.getElementById('fase').value = 'FUERA';
    }

    function volverAlTablero() { document.getElementById('view-list').style.display='none'; document.getElementById('view-dashboard-summary').style.display='block'; }
    function volverALista() { document.getElementById('view-detail').style.display='none'; if(categoriaActual) verLista(categoriaActual); else document.getElementById('view-list').style.display='block'; }
</script>
</body>
</html>